# Lab: Exploiting XXE via image file upload

>This lab lets users attach avatars to comments and uses the Apache Batik library to process avatar image files.

>To solve the lab, upload an image that displays the contents of the /etc/hostname file after processing. Then use the "Submit solution" button to submit the value of the server hostname.

### Observations
I thought it was unusual that portswigger told us what apache library they are using, so I googled `Apache Batik XXE` and found this page that provides more info https://insinuator.net/2015/03/xxe-injection-in-apache-batik-library-cve-2015-0250/

At first I created a file called `xxe9.jpg` and just created an xml external entity like so: `<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>` and then tried to call it. It uploaded without error, but nothing was returned

After reading the above document, I learned that .svg files can include xml, and that we can write text into an image

### Next steps
I slightly modified the payload from the article as follows, and then uploaded it:
`<?xml version="1.0" standalone="yes"?><!DOCTYPE ernw [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]><svg width="500px" height="100px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"><text font-family="Verdana" font-size="16" x="10" y="40">&xxe;</text></svg>`

It looks like the profile pic for the comment that I created with that payload was just a solid white color, instead of the "image not found" icon. So I used the inspect element tool to look at the profile pic, I saw some TINY text that was too distorted to read.

### Solution
I went back to the payload and changed the value of `font-size` to `32` and created another comment with my malicious .svg file. Now when I inspect element I can see the hostname!

Lab solved
